# Pipeline to build a nucleotide library

Builds libraries of dinucleotide and trinucleotide RNA fragments, at 0.5A and 1.0A precision.

In addition, this repo contains:

- Fragment clustering tools
- An algorithm to calculate the closest fit (nearest neighbour) of a fragment, excluding fragments from the same PDB;
- An algorithm to quickly estimate the completeness of a set of fragments. Completeness is defined as the percentage of the fragments that have a closest fit (excluding fragments from the same PDB) within a certain RMSD threshold.
- A tool and interactive notebook that uses the above algorithms to calculate the closest fit and completeness for a given Rfam/Pfam family, i.e. considering only fragments from outside the family as candidates for the closest fit.

## Library building instructions

Input: nonredundant nucleotide fragments (nucleotide-fragments submodule), generated by the nucleotide fragment pipeline.

Sublibraries are built at the dinucleotide and trinucleotide level, for each sequence motif and for each precision level.
Sequence motifs contain every combination of A and C (4 resp. 8 motifs for dinucleotide and trinucleotide). To extend to A/C/G/U, lib-mutate.py must be run after the steps have completed.

### Step 1. Download nucleotide fragments and fragment PDB templates

These are defined as Git submodules. Run the following command to download them:
`git submodule update --init --recursive --progress`

### Step 2. Run the clustering

Clustering is performed using a pairwise RMSD (after Kabsch superposition) cutoff that corresponds to the desired precision (0.5A, 1.0A and 2.0A).

For each sublibrary, clustering is performed by a removing iteratively the largest cluster from the fragment pool.The 50 largest clusters are determined probabilistically; for the remaining fragment pool, the full pairwise RMSD matrix is computed.

After the clustering is done, the origin (PDB code provenance) of each cluster is analyzed.

Scripts:

- clust.sh  (or equivalent script with parallel cluster jobs)
- clust-origin.sh

### Step 3. Build the library

Script to run:

- build-library.sh  (or equivalent script with parallel cluster jobs)

## Closest fit analysis

This repo contains an algorithm that calculates the closest fit (nearest-neighbour)
of each fragment, excluding fragments from the same PDB.

Scripts to run:

- closest-fit.sh (or equivalent script with parallel cluster jobs)
- The closest-fit-analysis notebook to verify the calculation against a brute force approach.

## Completeness analysis

This repo contains an algorithm to quickly estimate the completeness of a set of fragments. Completeness is defined as the percentage of the fragments that have a closest fit (excluding fragments from the same PDB) within a certain RMSD threshold.

Scripts to run:

- The notebook in the verification/ subfolder, to compare the calculation

## Context-specific analysis

- This repo contains a tool and interactive notebook that uses the above algorithms to calculate the closest fit and completeness in a *context-specific* manner. Here, *context* means a binary label that a fragment has or has not: the closest fit and completeness are calculated for all fragments within the context, but only fragments without the context are considered as candidates for the closest fit.
An experienced user can supply their own context labeling, but two have been implemented here:

- Is the fragment associated with a certain protein domain family (Pfam)? If the fragment is part of at least one complex where a member of that Pfam interacts with RNA, then the context is positive, else it is negative.
- Is the fragment associated with a certain RNA family (Rfam)?

An interactive notebook is provided where the user chooses a library (dinuc or trinuc), a database (Rfam or Pfam), and a family ID. The notebook then quickly computes the context-specific completeness and then computes the closest fit RMSD, which is then plotted as a histogram. It is possible to select a sample (for each motif) from all fragments with the context. In that case,the calculation will finish within a few minutes, otherwise it takes up to an hour or two (for the largest families).

The notebook can be opened in Google Colab, without any installation on the user's computer:
<https://colab.research.google.com/github/sjdv1982/nucleotide-build-library/blob/main/context-specific/completeness.ipynb>
